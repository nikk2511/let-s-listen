<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>🎵 Let's Listen</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Inline CSS to ensure it loads */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 2rem 0;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .app-title {
            font-size: 3rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .app-subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 300;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .search-section {
            margin-bottom: 3rem;
        }

        .search-container {
            display: flex;
            justify-content: center;
        }

        .search-box {
            display: flex;
            background: white;
            border-radius: 50px;
            padding: 0.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 100%;
        }

        .search-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            border-radius: 50px;
            background: transparent;
        }

        .search-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .tracks-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .track-item {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .track-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .track-artwork {
            width: 60px;
            height: 60px;
            background: #f0f0f0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            color: #666;
        }

        .track-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .track-artist {
            color: #666;
            margin-bottom: 0.5rem;
        }

        .track-duration {
            color: #999;
            font-size: 0.9rem;
        }

        .state-message {
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .hidden {
            display: none !important;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-icon, .no-results-icon {
            font-size: 3rem;
            color: #e74c3c;
            margin-bottom: 1rem;
        }

        .retry-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
        }

        .retry-btn:hover {
            background: #5a6fd8;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .app-title {
                font-size: 2rem;
            }
            
            .app-subtitle {
                font-size: 1rem;
            }
            
            .header {
                padding: 1.5rem 0;
            }
            
            .header-content {
                padding: 0 1rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .search-box {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.75rem;
            }
            
            .search-input {
                padding: 0.75rem 1rem;
                font-size: 1rem;
                border-radius: 25px;
            }
            
            .search-btn {
                padding: 0.75rem 1.5rem;
                border-radius: 25px;
                font-size: 1rem;
            }
            
            .tracks-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .track-item {
                padding: 1rem;
            }
            
            .track-artwork {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .track-title {
                font-size: 1rem;
            }
            
            .track-artist {
                font-size: 0.9rem;
            }
            
            .track-duration {
                font-size: 0.8rem;
            }
            
            .state-message {
                padding: 2rem 1rem;
            }
            
            .loading-spinner {
                width: 30px;
                height: 30px;
            }
            
            .error-icon, .no-results-icon {
                font-size: 2rem;
            }
        }
        
        @media (max-width: 480px) {
            .app-title {
                font-size: 1.5rem;
            }
            
            .app-subtitle {
                font-size: 0.9rem;
            }
            
            .header {
                padding: 1rem 0;
            }
            
            .main-content {
                padding: 0.5rem;
            }
            
            .search-box {
                padding: 0.5rem;
            }
            
            .search-input {
                padding: 0.5rem 0.75rem;
                font-size: 0.9rem;
            }
            
            .search-btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            
            .track-item {
                padding: 0.75rem;
            }
            
            .track-artwork {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .track-title {
                font-size: 0.9rem;
            }
            
            .track-artist {
                font-size: 0.8rem;
            }
            
            .track-duration {
                font-size: 0.7rem;
            }
            
            .state-message {
                padding: 1.5rem 0.75rem;
            }
            
            .loading-spinner {
                width: 25px;
                height: 25px;
            }
            
            .error-icon, .no-results-icon {
                font-size: 1.5rem;
            }
        }
        
        /* Modal Responsive Styles */
        @media (max-width: 768px) {
            .modal-content {
                max-width: 90%;
                padding: 1.5rem;
                margin: 1rem;
            }
            
            .modal-title {
                font-size: 1.2rem;
            }
            
            .modal-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .modal-btn {
                width: 100%;
                padding: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .modal-content {
                padding: 1rem;
                margin: 0.5rem;
            }
            
            .modal-title {
                font-size: 1rem;
            }
            
            .modal-buttons {
                gap: 0.25rem;
            }
            
            .modal-btn {
                padding: 0.5rem;
                font-size: 0.9rem;
            }
        }
        
        /* Audio Player Responsive */
        @media (max-width: 768px) {
            #audioPlayer {
                left: 10px;
                right: 10px;
                bottom: 10px;
                padding: 0.75rem;
            }
            
            .test-audio {
                top: 10px;
                right: 10px;
                padding: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            #audioPlayer {
                left: 5px;
                right: 5px;
                bottom: 5px;
                padding: 0.5rem;
            }
            
            .test-audio {
                top: 5px;
                right: 5px;
                padding: 0.5rem;
            }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .track-item {
                min-height: 80px;
            }
            
            .search-btn, .modal-btn, .retry-btn {
                min-height: 44px;
            }
            
            .track-item:active {
                transform: scale(0.98);
            }
            
            .search-btn:active, .modal-btn:active, .retry-btn:active {
                transform: scale(0.95);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1 class="app-title">
                    <i class="fas fa-music"></i>
                    Let's Listen
                </h1>
                <p class="app-subtitle">Discover and play music from independent artists</p>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Search Section -->
            <section class="search-section">
            <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Search for songs, artists, or albums..." class="search-input">
                        <button id="searchBtn" class="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
            </div>
        </div>
            </section>

            <!-- Results Section -->
            <section class="results-section">
                <div id="loadingState" class="state-message hidden">
                    <div class="loading-spinner"></div>
                    <p>Searching for music...</p>
        </div>
        
                <div id="errorState" class="state-message hidden">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3>Oops! Something went wrong</h3>
                    <p id="errorMessage">Failed to search for tracks. Please try again.</p>
                    <button onclick="app.retrySearch()" class="retry-btn">Try Again</button>
        </div>
        
                <div id="noResultsState" class="state-message hidden">
                    <div class="no-results-icon">
                        <i class="fas fa-music"></i>
            </div>
                    <h3>No tracks found</h3>
                    <p>Try searching for different keywords or check your spelling.</p>
        </div>

                <div id="tracksContainer" class="tracks-container hidden"></div>
            </section>
        </main>
    </div>
    
    <script>
        // Inline JavaScript to ensure it loads
        console.log('🎵 Let\'s Listen - Inline Version Loading...');
        
        class LetsListenPlayer {
            constructor() {
                this.currentTracks = [];
                this.currentTrackIndex = 0;
                this.isPlaying = false;
                
                this.init();
            }
            
            init() {
                console.log('🚀 Initializing Let\'s Listen...');
                
                // Get elements
                this.searchInput = document.getElementById('searchInput');
                this.searchBtn = document.getElementById('searchBtn');
                this.tracksContainer = document.getElementById('tracksContainer');
                this.loadingState = document.getElementById('loadingState');
                this.errorState = document.getElementById('errorState');
                this.noResultsState = document.getElementById('noResultsState');
                
                // Add event listeners
                this.searchBtn.addEventListener('click', () => this.handleSearch());
                this.searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleSearch();
                });
                
                console.log('✅ Let\'s Listen initialized successfully!');
            }
            
            async handleSearch() {
                const query = this.searchInput.value.trim();
                if (!query) return;
                
                console.log('🔍 Searching for:', query);
                this.showLoading();
                
                try {
                    const tracks = await this.searchTracks(query);
                    this.displayTracks(tracks);
                } catch (error) {
                    console.error('❌ Search error:', error);
                    console.log('🔄 Falling back to demo data...');
                    this.showDemoResults(query);
                }
            }
            
            async searchTracks(query) {
                const url = `/api/search?query=${encodeURIComponent(query)}&limit=20`;
                
                console.log('📡 API URL:', url);
                console.log('🌐 Base URL:', window.location.origin);
                console.log('🔍 Full URL:', window.location.origin + url);
                
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    console.log('📊 Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('❌ API Error Response:', errorText);
                        let errorData = {};
                        try {
                            errorData = JSON.parse(errorText);
                        } catch (e) {
                            console.error('❌ Could not parse error response as JSON');
                        }
                        throw new Error(errorData.details || `HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('📊 API Response:', data);
                    
                    // Handle different response formats
                    if (Array.isArray(data)) {
                        return data;
                    } else if (data.data && Array.isArray(data.data)) {
                        return data.data;
                    } else {
                        throw new Error('Invalid response format from API');
                    }
                } catch (error) {
                    console.error('❌ Search error:', error);
                    throw error;
                }
            }
            
            displayTracks(tracks) {
                console.log('🎵 Displaying tracks:', tracks.length);
                
                this.currentTracks = tracks;
                this.hideAllStates();

                if (tracks.length === 0) {
                    this.showNoResults();
                    return;
                }

                this.tracksContainer.innerHTML = '';
                
                tracks.forEach((track, index) => {
                    const trackDiv = this.createTrackElement(track, index);
                    this.tracksContainer.appendChild(trackDiv);
                });
                
                this.tracksContainer.classList.remove('hidden');
            }
            
            createTrackElement(track, index) {
                const trackDiv = document.createElement('div');
                trackDiv.className = 'track-item';
                trackDiv.innerHTML = `
                    <div class="track-artwork">
                        ${track.artwork ? 
                            `<img src="${track.artwork['150x150']}" alt="Track artwork" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">` :
                            `<i class="fas fa-music"></i>`
                        }
                    </div>
                    <div class="track-title">${this.escapeHtml(track.title)}</div>
                    <div class="track-artist">${this.escapeHtml(track.user.name)}</div>
                    <div class="track-duration">${this.formatDuration(track.duration)}</div>
                `;
                
                trackDiv.addEventListener('click', () => {
                    this.showStreamingInfo(track);
                });
                
                return trackDiv;
            }
            
            showStreamingInfo(track) {
                // Show track details and try to play
                this.showTrackModal(track);
            }
            
            showTrackModal(track) {
                // Create modal for track details
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 15px;
                        padding: 2rem;
                        max-width: 500px;
                        width: 90%;
                        text-align: center;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        max-height: 90vh;
                        overflow-y: auto;
                    ">
                        <div style="font-size: 3rem; color: #667eea; margin-bottom: 1rem;">
                            <i class="fas fa-music"></i>
                        </div>
                        <h3 style="margin-bottom: 1rem; color: #333;">${this.escapeHtml(track.title)}</h3>
                        <p style="color: #666; margin-bottom: 1rem;">by ${this.escapeHtml(track.user.name)}</p>
                        <p style="color: #999; margin-bottom: 2rem;">Duration: ${this.formatDuration(track.duration)}</p>
                        
                        <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem; flex-wrap: wrap;">
                            <button onclick="app.playTrackFromModal('${JSON.stringify(track).replace(/"/g, '&quot;')}')" style="
                                background: #667eea;
                                color: white;
                                border: none;
                                padding: 0.75rem 1.5rem;
                                border-radius: 25px;
                                cursor: pointer;
                                font-size: 1rem;
                                min-width: 120px;
                                flex: 1;
                                max-width: 200px;
                            ">
                                <i class="fas fa-play"></i> Play
                            </button>
                            <a href="https://audius.co${track.permalink}" target="_blank" style="
                                background: #28a745;
                                color: white;
                                text-decoration: none;
                                padding: 0.75rem 1.5rem;
                                border-radius: 25px;
                                font-size: 1rem;
                                min-width: 120px;
                                flex: 1;
                                max-width: 200px;
                                display: inline-block;
                            ">
                                <i class="fas fa-external-link-alt"></i> Open on Audius
                            </a>
                        </div>
                        
                        <button onclick="this.closeModal()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 0.5rem 1rem;
                            border-radius: 20px;
                            cursor: pointer;
                        ">
                            Close
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add close functionality
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeModal();
                    }
                });
                
                // Store modal reference
                this.currentModal = modal;
            }
            
            closeModal() {
                if (this.currentModal) {
                    this.currentModal.remove();
                    this.currentModal = null;
                }
            }
            
            playTrack(trackId) {
                console.log('🎵 Attempting to play track:', trackId);
                
                // Try to play the track
                this.attemptAudioPlayback(trackId);
            }
            
            playTrackFromModal(trackJson) {
                try {
                    const track = JSON.parse(trackJson);
                    console.log('🎵 Playing track from modal:', track.title);
                    this.attemptAudioPlaybackWithTrack(track);
                } catch (error) {
                    console.error('❌ Error parsing track data:', error);
                    this.showAudioError();
                }
            }
            
            async attemptAudioPlaybackWithTrack(track) {
                try {
                    // For demo tracks, use a sample audio
                    if (track.title && track.title.includes('Demo Track')) {
                        this.playDemoAudio();
                        return;
                    }
                    
                    // Test with a known working audio URL first
                    console.log('🧪 Testing with sample audio URL...');
                    const testUrl = 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav';
                    this.playTestAudio(testUrl);
                    
                    // For real tracks, try to get audio URL
                    const audioUrl = await this.getAudioUrlFromTrack(track);
                    if (audioUrl) {
                        console.log('🎵 Found Audius audio URL, trying to play...');
                        this.playAudio(audioUrl);
                    } else {
                        console.log('❌ No Audius audio URL found');
                        this.showAudioError();
                    }
                } catch (error) {
                    console.error('❌ Audio playback error:', error);
                    this.showAudioError();
                }
            }
            
            playTestAudio(testUrl) {
                console.log('🧪 Testing audio player with sample URL:', testUrl);
                const testAudio = document.createElement('audio');
                testAudio.src = testUrl;
                testAudio.controls = true;
                testAudio.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 1003;
                    background: white;
                    padding: 1rem;
                    border-radius: 10px;
                    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                `;
                document.body.appendChild(testAudio);
                
                testAudio.addEventListener('error', (e) => {
                    console.error('❌ Test audio failed:', e);
                });
                
                testAudio.addEventListener('canplay', () => {
                    console.log('✅ Test audio can play - audio player works!');
                });
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (testAudio.parentNode) {
                        testAudio.parentNode.removeChild(testAudio);
                    }
                }, 10000);
            }
            
            async getAudioUrlFromTrack(track) {
                try {
                    // Try different audio sources
                    if (track.preview_url) {
                        console.log('✅ Using preview URL:', track.preview_url);
                        return track.preview_url;
                    }
                    
                    // Try to construct streaming URL
                    if (track.track_cid) {
                        const cdnEndpoints = [
                            'https://audius-creator-6.theblueprint.xyz',
                            'https://audius-content-13.figment.io',
                            'https://blockdaemon-audius-content-08.bdnodes.net',
                            'https://audius-content-14.cultur3stake.com'
                        ];
                        
                        for (const endpoint of cdnEndpoints) {
                            const audioUrl = `${endpoint}/content/${track.track_cid}`;
                            console.log('🔄 Trying CDN endpoint:', audioUrl);
                            
                            // Test if the URL is accessible
                            try {
                                const testResponse = await fetch(audioUrl, { method: 'HEAD' });
                                if (testResponse.ok) {
                                    console.log('✅ Found working audio URL:', audioUrl);
                                    return audioUrl;
                                }
                            } catch (e) {
                                console.log('❌ CDN endpoint failed:', endpoint);
                            }
                        }
                    }
                    
                    throw new Error('No audio source available');
                } catch (error) {
                    console.error('❌ Error getting audio URL:', error);
                    return null;
                }
            }
            
            async attemptAudioPlayback(trackId) {
                try {
                    // For demo tracks, use a sample audio
                    if (trackId === 'demo') {
                        this.playDemoAudio();
                        return;
                    }
                    
                    // For real tracks, try to construct audio URL
                    const audioUrl = await this.getAudioUrl(trackId);
                    if (audioUrl) {
                        this.playAudio(audioUrl);
                    } else {
                        this.showAudioError();
                    }
                } catch (error) {
                    console.error('❌ Audio playback error:', error);
                    this.showAudioError();
                }
            }
            
            playDemoAudio() {
                // Create a simple audio player for demo
                const audioPlayer = document.createElement('div');
                audioPlayer.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    right: 20px;
                    background: white;
                    border-radius: 15px;
                    padding: 1rem;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    z-index: 1001;
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                `;
                
                audioPlayer.innerHTML = `
                    <div style="font-size: 2rem; color: #667eea;">
                        <i class="fas fa-music"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #333;">Demo Track Playing</div>
                        <div style="color: #666; font-size: 0.9rem;">This is a demo - no actual audio</div>
                    </div>
                    <button onclick="this.stopDemoAudio()" style="
                        background: #dc3545;
                        color: white;
                        border: none;
                        padding: 0.5rem 1rem;
                        border-radius: 20px;
                        cursor: pointer;
                    ">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                `;
                
                document.body.appendChild(audioPlayer);
                this.demoPlayer = audioPlayer;
                
                // Auto-close after 5 seconds
                setTimeout(() => {
                    this.stopDemoAudio();
                }, 5000);
            }
            
            stopDemoAudio() {
                if (this.demoPlayer) {
                    this.demoPlayer.remove();
                    this.demoPlayer = null;
                }
            }
            
            async getAudioUrl(trackId) {
                try {
                    // Try to get the track details first
                    const response = await fetch(`/api/search?query=${encodeURIComponent(trackId)}&limit=1`);
                    if (!response.ok) throw new Error('Failed to fetch track details');
                    
                    const data = await response.json();
                    const track = data.data && data.data[0];
                    
                    if (!track) throw new Error('Track not found');
                    
                    // Try different audio sources
                    if (track.preview_url) {
                        console.log('✅ Using preview URL:', track.preview_url);
                        return track.preview_url;
                    }
                    
                    // Try to construct streaming URL
                    if (track.track_cid) {
                        const cdnEndpoints = [
                            'https://audius-creator-6.theblueprint.xyz',
                            'https://audius-content-13.figment.io',
                            'https://blockdaemon-audius-content-08.bdnodes.net',
                            'https://audius-content-14.cultur3stake.com'
                        ];
                        
                        for (const endpoint of cdnEndpoints) {
                            const audioUrl = `${endpoint}/content/${track.track_cid}`;
                            console.log('🔄 Trying CDN endpoint:', audioUrl);
                            
                            // Test if the URL is accessible
                            try {
                                const testResponse = await fetch(audioUrl, { method: 'HEAD' });
                                if (testResponse.ok) {
                                    console.log('✅ Found working audio URL:', audioUrl);
                                    return audioUrl;
                                }
                            } catch (e) {
                                console.log('❌ CDN endpoint failed:', endpoint);
                            }
                        }
                    }
                    
                    throw new Error('No audio source available');
                } catch (error) {
                    console.error('❌ Error getting audio URL:', error);
                    return null;
                }
            }
            
            playAudio(audioUrl) {
                console.log('🎵 Playing audio from:', audioUrl);
                console.log('🔍 Audio URL type:', typeof audioUrl);
                console.log('🔍 Audio URL length:', audioUrl ? audioUrl.length : 'null');
                
                // Create or get audio element
                let audio = document.getElementById('audioPlayer');
                if (!audio) {
                    audio = document.createElement('audio');
                    audio.id = 'audioPlayer';
                    audio.controls = true;
                    audio.preload = 'metadata';
                    audio.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        left: 20px;
                        right: 20px;
                        z-index: 1001;
                        background: white;
                        border-radius: 15px;
                        padding: 1rem;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                        display: none;
                    `;
                    document.body.appendChild(audio);
                }
                
                // Add event listeners for debugging
                audio.addEventListener('loadstart', () => {
                    console.log('🔄 Audio load started');
                });
                
                audio.addEventListener('loadedmetadata', () => {
                    console.log('✅ Audio metadata loaded');
                    console.log('📊 Audio duration:', audio.duration);
                });
                
                audio.addEventListener('canplay', () => {
                    console.log('✅ Audio can play');
                });
                
                audio.addEventListener('error', (e) => {
                    console.error('❌ Audio error event:', e);
                    console.error('❌ Audio error details:', audio.error);
                });
                
                // Set audio source and play
                audio.src = audioUrl;
                audio.load();
                
                // Show the player first
                audio.style.display = 'block';
                
                audio.play().then(() => {
                    console.log('✅ Audio started playing successfully');
                    this.showAudioPlayer(audio);
                }).catch(error => {
                    console.error('❌ Audio play failed:', error);
                    console.error('❌ Error name:', error.name);
                    console.error('❌ Error message:', error.message);
                    this.showAudioError();
                });
            }
            
            showAudioPlayer(audio) {
                // Show the audio player
                audio.style.display = 'block';
                
                // Auto-hide after 10 seconds if no interaction
                setTimeout(() => {
                    if (audio.paused) {
                        audio.style.display = 'none';
                    }
                }, 10000);
            }
            
            showAudioError() {
                // Create a better error modal instead of alert
                const errorModal = document.createElement('div');
                errorModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1002;
                `;
                
                errorModal.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 15px;
                        padding: 2rem;
                        max-width: 400px;
                        width: 90%;
                        text-align: center;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                    ">
                        <div style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 style="margin-bottom: 1rem; color: #333;">Audio Not Available</h3>
                        <p style="color: #666; margin-bottom: 2rem;">
                            This track cannot be played directly in the app due to streaming restrictions.
                        </p>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button onclick="this.closeErrorModal()" style="
                                background: #6c757d;
                                color: white;
                                border: none;
                                padding: 0.75rem 1.5rem;
                                border-radius: 25px;
                                cursor: pointer;
                            ">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(errorModal);
                
                // Add close functionality
                errorModal.addEventListener('click', (e) => {
                    if (e.target === errorModal) {
                        errorModal.remove();
                    }
                });
                
                // Store reference for close button
                window.closeErrorModal = () => {
                    errorModal.remove();
                };
            }
            
            showDemoResults(query) {
                console.log('🎭 Showing demo results for:', query);
                this.hideAllStates();
                
                const demoTracks = [
                    {
                        title: `Demo Track 1 - ${query}`,
                        user: { name: "Demo Artist 1" },
                        duration: 180,
                        artwork: null,
                        is_streamable: false
                    },
                    {
                        title: `Demo Track 2 - ${query}`, 
                        user: { name: "Demo Artist 2" },
                        duration: 240,
                        artwork: null,
                        is_streamable: false
                    },
                    {
                        title: `Demo Track 3 - ${query}`,
                        user: { name: "Demo Artist 3" },
                        duration: 200,
                        artwork: null,
                        is_streamable: false
                    }
                ];
                
                this.displayTracks(demoTracks);
                
                // Show a notice that this is demo data
                const notice = document.createElement('div');
                notice.style.cssText = `
                    background: #fff3cd;
                    border: 1px solid #ffeaa7;
                    color: #856404;
                    padding: 1rem;
                    border-radius: 10px;
                    margin-bottom: 1rem;
                    text-align: center;
                `;
                notice.innerHTML = `
                    <strong>⚠️ Demo Mode:</strong> API is not responding. Showing demo results. 
                    <br>Try refreshing the page or check the console for errors.
                `;
                this.tracksContainer.parentNode.insertBefore(notice, this.tracksContainer);
            }
            
            showLoading() {
                this.hideAllStates();
                this.loadingState.classList.remove('hidden');
            }
            
            showError(message) {
                this.hideAllStates();
                document.getElementById('errorMessage').textContent = message;
                this.errorState.classList.remove('hidden');
            }
            
            showNoResults() {
                this.hideAllStates();
                this.noResultsState.classList.remove('hidden');
            }
            
            hideAllStates() {
                this.loadingState.classList.add('hidden');
                this.errorState.classList.add('hidden');
                this.noResultsState.classList.add('hidden');
                this.tracksContainer.classList.add('hidden');
            }
            
            retrySearch() {
                this.handleSearch();
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            formatDuration(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM Content Loaded');
            window.app = new LetsListenPlayer();
        });
        
        // Also try to initialize immediately
        if (document.readyState === 'loading') {
            console.log('⏳ Document still loading...');
        } else {
            console.log('🚀 Document already loaded, initializing now...');
            window.app = new LetsListenPlayer();
        }
    </script>
</body>
</html>